<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="mimimum-scale=1, initial-scale=1, width=device-width, height=device-height, shrink-to-fit=no" />
    <title>Pledger Sample Dapp</title>
  </head>

  <body>
    <h2>Pledger Sample Dapp</h2>

    <p>Here is a little web interface that tests the Pledger-over-CapTP integration with localhost:8000.</p>

    <textarea id="output" style="width: 100%; height: 500px"></textarea>

    <script type="text/javascript" src="captp.umd.js"></script>
    <script type="text/javascript" src="pledger-web-bridge.js"></script>
    <script type="text/javascript">
const { E, harden, makeCapTP } = CapTP;

createPledgerBridge(startPledgerSession);
const log = (...msg) => {
  console.log(...msg);
  output.value += msg.join(' ') + '\n';
};

async function getBalances(pledger) {
  log('Get balances:');
  const [changedP, balances] = await E(pledger).getBalances();
  log(JSON.stringify(balances, undefined, 2));
  changedP.then(
    () => getBalances(pledger),
    e => log('Pledger getBalance', name, 'error:', e),
  );
  return balances;
}

async function startPledgerSession(getBootstrap) {
  try {
    log('Starting dapp');
    await E(getBootstrap()).wait();
    log('Pledger is ready, now continuing dapp');
    const pledger = E(getBootstrap()).getPledger();
    await getBalances(pledger);
    log('Entering wait loop');
  } catch (e) {
    log('Pledger session error:', e);
  }
};
    </script>
  </body>
</html>
